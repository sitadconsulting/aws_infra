import sys
import random
import time
import boto3
import json
import uuid
from awsglue.utils import getResolvedOptions
args = getResolvedOptions(sys.argv, ['STREAM_NAME'])
stream_name = args['STREAM_NAME']

kinesis=boto3.client('kinesis')

def get_item_information():
    item_information = "AMZ83BV4760~~MLP~~24.738#AMZ93BV3045~~THP~~17.3476#AMZ89BV7586~~THP~~17.3476#AMZ50BV5779~~AP~~5.6544#AMZ91BV5488~~AP~~11.47#AMZ34BV6161~~DF~~7.4276#AMZ51BV3137~~PR~~3.7076#AMZ45BV3473~~DL~~8.6676#AMZ79BV2915~~FD~~2.2196#AMZ75BV0342~~FD~~2.2816#AMZ20BV8266~~DP~~3.224#AMZ94BV5209~~MM~~6.138#AMZ04BV5361~~MB~~24.7876#AMZ93BV3160~~MB~~14.0492#AMZ38BV9025~~PP~~37.1876#AMZ83BV5527~~PP~~8.2956#AMZ76BV3067~~PP~~7.4276#AMZ23BV2742~~MT~~16.1076#AMZ82BV5376~~MT~~16.1076#AMZ25BV7867~~DW~~15.562#AMZ22BV2730~~DW~~25.3704#AMZ84BV5267~~BA~~119.04#AMZ36BV7570~~BA~~223.2#AMZ95BV7979~~GT~~79.8932#AMZ52BV1296~~GT~~2.9636#AMZ92BV2005~~GT~~11.1476#AMZ46BV7485~~GT~~8.6676#AMZ38BV2950~~TR~~60.6732#AMZ53BV1739~~SF~~10.2176#AMZ89BV4260~~MLP~~17.9056#AMZ48BV1592~~AF~~18.3396#AMZ53BV6387~~LR~~11.0608#AMZ29BV5477~~LR~~24.304#AMZ02BV8347~~VT~~35.96#AMZ64BV4458~~VT~~6.1876#AMZ25BV3504~~VT~~14.26#AMZ57BV1561~~VT~~4.8856#AMZ87BV3018~~EF~~2.17#AMZ58BV1286~~EF~~1.984#AMZ14BV4735~~EF~~1.8476#AMZ82BV5807~~AP~~12.462#AMZ14BV3202~~AP~~6.82#AMZ48BV5925~~AP~~6.2248#AMZ06BV9630~~AP~~7.936#AMZ61BV5299~~AP~~3.8316#AMZ20BV1090~~GSC~~34.0628#AMZ55BV2172~~MCH~~11.1476#AMZ43BV1183~~MCH~~48.3476#AMZ82BV5324~~DF~~24.49#AMZ60BV0008~~PR~~61.3676#AMZ60BV1838~~DL~~18.5876#AMZ14BV1712~~DL~~18.91#AMZ09BV9249~~DL~~11.966#AMZ15BV5630~~DL~~36.332#AMZ13BV8483~~FD~~2.7776#AMZ60BV3006~~DP~~1.8476#AMZ07BV7668~~DP~~37.076#AMZ61BV0013~~MM~~6.1628#AMZ31BV2521~~MB~~40.8828#AMZ48BV1318~~MB~~32.2276#AMZ83BV3607~~MB~~12.3876#AMZ17BV4290~~MT~~32.9964#AMZ91BV9013~~MT~~18.5876#AMZ07BV7859~~DJ~~37.2#AMZ00BV5458~~DJ~~28.9788#AMZ11BV3296~~DJ~~5.5676#AMZ14BV0435~~DW~~19.84#AMZ56BV4995~~DW~~27.2676#AMZ14BV1259~~BA~~123.938#AMZ75BV5977~~BA~~187.2276#AMZ16BV7590~~GT~~11.2716#AMZ67BV2801~~TR~~12.3876#AMZ22BV5398~~FS~~16.802#AMZ74BV8513~~FS~~16.492#AMZ79BV0881~~SF~~17.3476#AMZ91BV9072~~SF~~15.4876#AMZ39BV2126~~AF~~8.6676#AMZ59BV4555~~AF~~9.2876#AMZ24BV3509~~THP~~16.1076#AMZ80BV4848~~THP~~14.8676#AMZ80BV8678~~LR~~4.96#AMZ88BV7659~~VT~~16.1076#AMZ48BV4984~~VT~~16.1076#AMZ42BV5620~~VT~~11.78#AMZ08BV4758~~EF~~1.736#AMZ75BV8370~~EF~~2.4676#AMZ95BV6944~~EF~~2.976#AMZ49BV6248~~EF~~1.1656#AMZ23BV5845~~AP~~5.3444#AMZ11BV5012~~GSC~~37.1752#AMZ29BV1106~~MCH~~57.0276#AMZ84BV4604~~DF~~6.7952#AMZ75BV3010~~DF~~14.818#AMZ14BV0147~~PR~~34.658#AMZ56BV3479~~PR~~32.2276#AMZ82BV6603~~PR~~18.4264#AMZ04BV7380~~PR~~123.9876#AMZ42BV0208~~DL~~27.9#AMZ46BV9573~~DL~~55.8#AMZ27BV5135~~DP~~9.858#AMZ33BV1706~~MM~~2.418#AMZ79BV5678~~MM~~6.8076#AMZ84BV4605~~MB~~12.3876#AMZ03BV7079~~PP~~6.1752#AMZ76BV0042~~PP~~10.6392#AMZ47BV6399~~MT~~21.0056#AMZ64BV5750~~MT~~16.1076#AMZ54BV7109~~DJ~~4.3028#AMZ06BV6673~~DJ~~17.3476#AMZ99BV0602~~DJ~~12.338#AMZ62BV5426~~DW~~7.4028#AMZ92BV5949~~DW~~21.08#AMZ36BV9571~~DW~~12.2512#AMZ80BV5701~~BA~~119.102#AMZ72BV8852~~BA~~14.88#AMZ51BV3319~~GT~~18.5876#AMZ28BV9514~~TR~~37.1876#AMZ59BV9376~~TR~~119.0276#AMZ03BV9855~~FS~~15.1032#AMZ55BV7682~~FS~~17.608#AMZ87BV7130~~SF~~17.7196#AMZ37BV2019~~SF~~23.4484#AMZ17BV4353~~SF~~15.2148#AMZ84BV1034~~SF~~8.3452#AMZ92BV4794~~MLP~~28.8672#AMZ54BV9703~~MLP~~66.96#AMZ70BV5290~~THP~~17.3476#AMZ39BV8247~~THP~~16.1076#AMZ51BV4228~~THP~~14.8676#AMZ31BV3981~~THP~~14.8676#AMZ88BV1375~~LR~~26.536#AMZ22BV2530~~VT~~11.7552#AMZ87BV8038~~EF~~2.294#AMZ24BV5502~~EF~~1.1036#AMZ20BV1133~~GSC~~207.8364#AMZ66BV3346~~GSC~~70.8164#AMZ70BV7519~~MCH~~99.1876#AMZ84BV3740~~MCH~~44.2928#AMZ76BV2848~~MCH~~100.378#AMZ66BV2306~~DF~~9.9076#AMZ38BV0356~~DF~~15.748#AMZ40BV8078~~DF~~6.82#AMZ90BV7763~~PR~~9.9076#AMZ39BV3665~~DL~~15.252#AMZ60BV6474~~FD~~2.1328#AMZ42BV7636~~FD~~3.0504#AMZ53BV9070~~FD~~2.0336#AMZ08BV9655~~FD~~2.046#AMZ23BV7599~~DP~~3.72#AMZ22BV1803~~DP~~173.5132#AMZ25BV8838~~MM~~1.798#AMZ86BV6615~~MM~~3.658#AMZ42BV3604~~MB~~43.3876#AMZ35BV6677~~PP~~12.3876#AMZ00BV3306~~PP~~13.516#AMZ04BV1389~~MT~~18.5752#AMZ79BV3879~~DJ~~6.2#AMZ16BV0923~~DW~~9.9076#AMZ62BV7959~~DW~~23.8328#AMZ19BV0969~~GT~~17.3476#AMZ08BV3393~~TR~~14.8676#AMZ86BV7006~~TR~~63.4384#AMZ20BV6897~~FS~~21.0304#AMZ72BV4071~~FS~~23.498#AMZ45BV9571~~FS~~24.738#AMZ73BV6654~~FS~~21.0676#AMZ41BV5123~~FS~~27.6396#AMZ21BV8553~~FS~~20.3112#AMZ52BV8018~~FS~~21.08#AMZ79BV9237~~SF~~8.9404#AMZ99BV2269~~SF~~13.5284#AMZ69BV2139~~SF~~21.948#AMZ99BV1903~~MLP~~9.61#AMZ49BV0955~~AF~~24.7876#AMZ72BV6427~~AF~~80.538#AMZ26BV7878~~AF~~20.2492#AMZ47BV3432~~AF~~6.2992#AMZ32BV0133~~THP~~14.8676#AMZ52BV8268~~GSC~~17.1492#AMZ49BV1012~~MCH~~40.3#AMZ46BV5844~~DF~~39.0724#AMZ05BV8703~~PR~~59.6564#AMZ17BV2532~~PR~~8.6676#AMZ01BV4712~~PR~~19.8276#AMZ38BV9442~~PR~~7.4276#AMZ74BV0572~~FD~~2.5792#AMZ29BV3350~~FD~~2.79#AMZ57BV1615~~FD~~1.984#AMZ21BV7768~~FD~~2.2816#AMZ89BV1560~~MB~~3.3356#AMZ64BV7749~~MB~~15.6488#AMZ31BV3764~~DP~~1.488#AMZ54BV4599~~DP~~4.1788#AMZ44BV8724~~DP~~9.4488#AMZ70BV8437~~DP~~7.378#AMZ82BV6397~~MT~~29.7476#AMZ87BV1009~~MT~~13.6276#AMZ79BV5632~~DW~~11.7676#AMZ29BV5600~~GT~~18.5876#AMZ35BV6455~~GT~~7.4276#AMZ22BV9474~~BA~~124.0#AMZ87BV6206~~BA~~129.8404#AMZ51BV3202~~TR~~14.8676#AMZ80BV5019~~FS~~17.8436#AMZ78BV9447~~SF~~13.9128#AMZ31BV6341~~MLP~~22.63#AMZ86BV6332~~MLP~~6.1876#AMZ32BV5822~~MLP~~28.8672#AMZ32BV9117~~MLP~~9.7216#AMZ12BV9901~~AF~~20.7824#AMZ47BV0039~~THP~~13.6276#AMZ45BV7137~~THP~~16.988#AMZ61BV1304~~THP~~17.3476#AMZ40BV9525~~LR~~23.498#AMZ12BV4545~~EF~~1.426#AMZ85BV2086~~AP~~8.2584#AMZ69BV5796~~GSC~~48.6576#AMZ17BV6179~~GSC~~93.62#AMZ42BV6972~~GSC~~41.5524#AMZ22BV4053~~MCH~~44.578#AMZ84BV5264~~MCH~~189.5092#AMZ51BV1669~~PR~~9.9076#AMZ16BV5353~~DL~~12.648#AMZ11BV2484~~FD~~1.7608#AMZ16BV9600~~FD~~1.7112#AMZ97BV8053~~DF~~2.976#AMZ12BV8721~~DF~~16.926#AMZ09BV4723~~DP~~6.2992#AMZ71BV0659~~DP~~5.1956#AMZ67BV2113~~MM~~3.3852#AMZ53BV3023~~MM~~4.9476#AMZ47BV2957~~MM~~3.7076#AMZ99BV8120~~MB~~24.7752#AMZ78BV7879~~MT~~15.3264#AMZ37BV1576~~MT~~15.6612#AMZ50BV1084~~MT~~12.338#AMZ37BV3472~~DJ~~28.5076#AMZ30BV9395~~DJ~~28.4456#AMZ81BV6180~~DJ~~17.3476#AMZ09BV9391~~GT~~12.3876#AMZ87BV3090~~GT~~9.4488#AMZ11BV5492~~BA~~185.9008#AMZ28BV7387~~BA~~129.7784#AMZ52BV4282~~BA~~154.9132#AMZ68BV0746~~BA~~118.792#AMZ61BV0897~~TR~~26.0276#AMZ86BV7327~~TR~~280.736#AMZ89BV5728~~FS~~17.0996#AMZ75BV5374~~SF~~9.796#AMZ38BV6090~~SF~~14.6444#AMZ29BV0068~~PP~~2.728#AMZ01BV4219~~PP~~2.4304#AMZ80BV9271~~AF~~7.254#AMZ69BV5974~~VT~~11.7676#AMZ25BV3971~~LR~~11.098#AMZ16BV1840~~LR~~22.2828#AMZ28BV0408~~LR~~11.1476#AMZ29BV1580~~AP~~3.0132#AMZ23BV1856~~DL~~18.5876#AMZ29BV2458~~DL~~124.0#AMZ72BV7673~~DL~~13.6276#AMZ95BV3522~~DL~~12.1396#AMZ17BV9692~~FD~~2.0336#AMZ86BV5703~~DF~~7.3656#AMZ36BV9314~~DP~~2.8644#AMZ11BV6142~~DP~~7.4276#AMZ87BV5429~~DP~~12.3876#AMZ22BV7300~~MM~~3.038#AMZ10BV8707~~MM~~12.3876#AMZ96BV0651~~MM~~14.1732#AMZ51BV8224~~MM~~6.1876#AMZ92BV5956~~MB~~20.9808#AMZ39BV1016~~MB~~18.5876#AMZ76BV1634~~MB~~26.0276#AMZ20BV8893~~MT~~20.9436#AMZ22BV1666~~MT~~12.214#AMZ20BV5353~~MT~~18.6#AMZ77BV7533~~DJ~~16.1076#AMZ93BV6971~~DJ~~18.5876#AMZ90BV0800~~DW~~12.338#AMZ09BV2947~~DW~~30.9628#AMZ11BV6477~~DW~~3.7076#AMZ71BV8865~~GT~~6.138#AMZ95BV1588~~GT~~12.8836#AMZ42BV1181~~BA~~154.9876#AMZ03BV2242~~TR~~40.9076#AMZ70BV2407~~TR~~22.3076#AMZ27BV0858~~TR~~38.4276#AMZ86BV2132~~FS~~21.0676#AMZ39BV8260~~FS~~16.2812#AMZ43BV5821~~FS~~3.4596#AMZ77BV1701~~FS~~18.724#AMZ49BV2025~~PP~~12.3628#AMZ18BV9702~~PP~~24.7628#AMZ74BV8324~~PP~~7.4276#AMZ08BV6907~~MLP~~12.3504#AMZ79BV4326~~AF~~22.258#AMZ56BV5505~~VT~~23.5476#AMZ38BV7213~~LR~~53.3076#AMZ69BV7063~~LR~~22.258#AMZ41BV8358~~EF~~1.86#AMZ30BV5198~~GSC~~39.3452#AMZ47BV8081~~GSC~~167.8464#AMZ65BV1438~~GSC~~39.5312#AMZ40BV9706~~MCH~~11.2716#AMZ70BV5238~~MCH~~60.7476#AMZ91BV9301~~MCH~~37.1876#AMZ65BV9670~~DF~~30.9628#AMZ00BV7982~~DF~~56.9904#AMZ76BV3582~~PR~~12.3876#AMZ22BV2051~~PR~~12.09#AMZ98BV1566~~DL~~92.504#AMZ53BV9825~~DL~~14.818#AMZ13BV8792~~FD~~3.5588#AMZ35BV9428~~FD~~1.6492#AMZ29BV8355~~DP~~12.3876#AMZ59BV7613~~MM~~1.9964#AMZ90BV8664~~MB~~24.7876#AMZ92BV3893~~MT~~17.4344#AMZ03BV1348~~MT~~9.2752#AMZ40BV3527~~MT~~18.6#AMZ72BV1528~~MT~~16.1076#AMZ69BV6548~~DJ~~13.0944#AMZ01BV3777~~DJ~~14.694#AMZ32BV2789~~DJ~~12.3876#AMZ92BV9773~~DJ~~29.7476#AMZ18BV7217~~DJ~~30.9628#AMZ49BV1854~~DJ~~8.6676#AMZ22BV8348~~DW~~3.7076#AMZ50BV0965~~DW~~6.1876#AMZ18BV0941~~DW~~13.6152#AMZ42BV1006~~GT~~18.3396#AMZ73BV8511~~GT~~6.4108#AMZ50BV0985~~GT~~12.8092#AMZ30BV3975~~BA~~11.904#AMZ34BV8501~~BA~~181.164#AMZ22BV8785~~BA~~24.8#AMZ94BV7563~~BA~~86.8#AMZ51BV7304~~TR~~122.7476#AMZ48BV7691~~TR~~69.5888#AMZ18BV0069~~FS~~16.5912#AMZ51BV3820~~FS~~19.8276#AMZ83BV1407~~FS~~27.8256#AMZ91BV0918~~SF~~17.8436#AMZ36BV6124~~SF~~6.82#AMZ29BV4552~~PP~~1.9344"
    return (random.choice(item_information.split("#"))).strip()

def get_promotion_percent():
    promotion_percent_list="10,10,10,20,20,50,75,30"
    return int((random.choice(promotion_percent_list.split(","))).strip())

def get_new_promotion_percent():
    new_promotion_percent_list="40,50,75,30"
    return int((random.choice(new_promotion_percent_list.split(","))).strip())

def get_quantity_purchased():
    quantity_list="1,2,3,4,1,1,1,1,1,2"
    return int((random.choice(quantity_list.split(","))).strip())

def get_timestamp():
    date_time_str = time.strftime("%Y-%m-%d %H:%M:%S",time.localtime())
    return date_time_str

def send(stream_name,kinesis,data):
    data_string = json.dumps(data)
    #print(data_string)
    kinesis.put_record(StreamName=stream_name,Data=data_string,PartitionKey=data['order_id'])
    return None

def get_txn_id():
    return str(uuid.uuid4().hex)

def is_update_interval(oldtime):
    if time.time() - oldtime > 179:
        return True
    return False

def get_purchase_price(unit_price, qty,discount):
    purchase_price = 0
    price = unit_price * qty
    discount_usd = round(price*discount/100,2)
    purchase_price = round((price - discount_usd),2)
    return purchase_price

def trigger_update(repeat,kinesis,stream_name):
    for data in repeat:
         promotion_percentage = get_new_promotion_percent()
         data['purchase_price']=get_purchase_price(data['product_price'],data['quantity'],promotion_percentage)
         current_code=data['promotion_code']
         data['promotion_code'] = current_code.split("DISCOUNT")[0]+"DISCOUNT"+str(promotion_percentage)
         data['event_time'] = get_timestamp()
         send(stream_name,kinesis,data)
    return None

repeat = list()
oldtime = time.time()

for x in range(9000):
    data={}
    if(is_update_interval(oldtime)):
        trigger_update(repeat,kinesis,stream_name)
        oldtime = time.time()
        repeat = list()
    item_info_string = get_item_information()
    items_info = item_info_string.split('~~')
    item_id = items_info[0].strip()
    promotion_percentage = get_promotion_percent()
    promo_code=items_info[1].strip()+"DISCOUNT"+str(promotion_percentage)
    price=round(float(items_info[2].strip()),2)
    purchase_quantity=get_quantity_purchased()
    data['order_id']=get_txn_id()
    data['product_id']=item_id
    data['event_time'] = get_timestamp()
    data['promotion_code']=promo_code
    data['product_price']=price
    data['quantity']=purchase_quantity
    data['purchase_price']=get_purchase_price(price,purchase_quantity,promotion_percentage)
    if len(repeat) <25 and promotion_percentage <30 :
        repeat.append(data)
    send(stream_name,kinesis,data)
    if (x%500) == 0:
        time.sleep(3)

